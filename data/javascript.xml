<?xml version="1.0" encoding="UTF-8"?>
<javascript app="membermap">
 <file javascript_app="membermap" javascript_location="front" javascript_path="controllers/main" javascript_name="jquery.showLoading.min.js" javascript_type="controller" javascript_version="100003" javascript_position="1000050"><![CDATA[ï»¿/*
 * jQuery showLoading plugin v1.0
 * 
 * Copyright (c) 2009 Jim Keller
 * Context - http://www.contextllc.com
 * 
 * Dual licensed under the MIT and GPL licenses.
 *
 */
jQuery.fn.showLoading=function(options){var indicatorID;var settings={'addClass':'','beforeShow':'','afterShow':'','hPos':'center','vPos':'center','indicatorZIndex':5001,'overlayZIndex':5000,'parent':'','marginTop':0,'marginLeft':0,'overlayWidth':null,'overlayHeight':null};jQuery.extend(settings,options);var loadingDiv=jQuery('<div></div>');var overlayDiv=jQuery('<div></div>');if(settings.indicatorID){indicatorID=settings.indicatorID;}
else{indicatorID=jQuery(this).attr('id');}
jQuery(loadingDiv).attr('id','loading-indicator-'+indicatorID);jQuery(loadingDiv).addClass('loading-indicator');if(settings.addClass){jQuery(loadingDiv).addClass(settings.addClass);}
jQuery(overlayDiv).css('display','none');jQuery(document.body).append(overlayDiv);jQuery(overlayDiv).attr('id','loading-indicator-'+indicatorID+'-overlay');jQuery(overlayDiv).addClass('loading-indicator-overlay');if(settings.addClass){jQuery(overlayDiv).addClass(settings.addClass+'-overlay');}
var overlay_width;var overlay_height;var border_top_width=jQuery(this).css('border-top-width');var border_left_width=jQuery(this).css('border-left-width');border_top_width=isNaN(parseInt(border_top_width))?0:border_top_width;border_left_width=isNaN(parseInt(border_left_width))?0:border_left_width;var overlay_left_pos=jQuery(this).offset().left+parseInt(border_left_width);var overlay_top_pos=jQuery(this).offset().top+parseInt(border_top_width);if(settings.overlayWidth!==null){overlay_width=settings.overlayWidth;}
else{overlay_width=parseInt(jQuery(this).width())+parseInt(jQuery(this).css('padding-right'))+parseInt(jQuery(this).css('padding-left'));}
if(settings.overlayHeight!==null){overlay_height=settings.overlayWidth;}
else{overlay_height=parseInt(jQuery(this).height())+parseInt(jQuery(this).css('padding-top'))+parseInt(jQuery(this).css('padding-bottom'));}
jQuery(overlayDiv).css('width',overlay_width.toString()+'px');jQuery(overlayDiv).css('height',overlay_height.toString()+'px');jQuery(overlayDiv).css('left',overlay_left_pos.toString()+'px');jQuery(overlayDiv).css('position','absolute');jQuery(overlayDiv).css('top',overlay_top_pos.toString()+'px');jQuery(overlayDiv).css('z-index',settings.overlayZIndex);if(settings.overlayCSS){jQuery(overlayDiv).css(settings.overlayCSS);}
jQuery(loadingDiv).css('display','none');jQuery(document.body).append(loadingDiv);jQuery(loadingDiv).css('position','absolute');jQuery(loadingDiv).css('z-index',settings.indicatorZIndex);var indicatorTop=overlay_top_pos;if(settings.marginTop){indicatorTop+=parseInt(settings.marginTop);}
var indicatorLeft=overlay_left_pos;if(settings.marginLeft){indicatorLeft+=parseInt(settings.marginTop);}
if(settings.hPos.toString().toLowerCase()=='center'){jQuery(loadingDiv).css('left',(indicatorLeft+((jQuery(overlayDiv).width()-parseInt(jQuery(loadingDiv).width()))/2)).toString()+'px');}
else if(settings.hPos.toString().toLowerCase()=='left'){jQuery(loadingDiv).css('left',(indicatorLeft+parseInt(jQuery(overlayDiv).css('margin-left'))).toString()+'px');}
else if(settings.hPos.toString().toLowerCase()=='right'){jQuery(loadingDiv).css('left',(indicatorLeft+(jQuery(overlayDiv).width()-parseInt(jQuery(loadingDiv).width()))).toString()+'px');}
else{jQuery(loadingDiv).css('left',(indicatorLeft+parseInt(settings.hPos)).toString()+'px');}
if(settings.vPos.toString().toLowerCase()=='center'){jQuery(loadingDiv).css('top',(indicatorTop+((jQuery(overlayDiv).height()-parseInt(jQuery(loadingDiv).height()))/2)).toString()+'px');}
else if(settings.vPos.toString().toLowerCase()=='top'){jQuery(loadingDiv).css('top',indicatorTop.toString()+'px');}
else if(settings.vPos.toString().toLowerCase()=='bottom'){jQuery(loadingDiv).css('top',(indicatorTop+(jQuery(overlayDiv).height()-parseInt(jQuery(loadingDiv).height()))).toString()+'px');}
else{jQuery(loadingDiv).css('top',(indicatorTop+parseInt(settings.vPos)).toString()+'px');}
if(settings.css){jQuery(loadingDiv).css(settings.css);}
var callback_options={'overlay':overlayDiv,'indicator':loadingDiv,'element':this};if(typeof(settings.beforeShow)=='function'){settings.beforeShow(callback_options);}
jQuery(overlayDiv).show();jQuery(loadingDiv).show();if(typeof(settings.afterShow)=='function'){settings.afterShow(callback_options);}
return this;};jQuery.fn.hideLoading=function(options){var settings={};jQuery.extend(settings,options);if(settings.indicatorID){indicatorID=settings.indicatorID;}
else{indicatorID=jQuery(this).attr('id');}
jQuery(document.body).find('#loading-indicator-'+indicatorID).remove();jQuery(document.body).find('#loading-indicator-'+indicatorID+'-overlay').remove();return this;};
]]></file>
 <file javascript_app="membermap" javascript_location="front" javascript_path="controllers/main" javascript_name="membermap.js" javascript_type="controller" javascript_version="100003" javascript_position="1000050"><![CDATA[/**
 * Trip Report, by Martin Aronsen
 */
;( function($, _, undefined){
	"use strict";

	ips.createModule('ips.membermap', function() 
	{
		var map = null,
			oms = null,
			geocoder = null,
			defaultMapTypeId = null,
			
			zoomLevel = null,
			previousZoomLevel = null,
			
			initialCenter = null,
			
			mapServices = [],
			
			baseMaps = {},
			overlayMaps = {},
			
			mapMarkers = null,
			allMarkers = [],
			
			icons = [],
			infoWindow = null,
			info = null,
			currentPlace = null,
			isMobileDevice = false,
			isEmbedded = false,
			
			bounds = null,
			
			stuffSize = 0,
			popups = [],

			markerContext = {},

			oldMarkersIndicator = null,

			hasLocation = false;
	
		var initMap = function()
		{
			/* Safari gets cranky if this is loaded after the map is set up */
			$( window ).on( 'scroll resize', function()
			{
				/* Attempting to scroll above viewport caused flickering */
				if ( window.scrollY < 0 )
				{
					return false;
				}
				
				setMapHeight();
				
				map.invalidateSize();
			});

			setMobileDevice( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) );


			/* Showing a single user or online user, get the markers from DOM */
			var getByUser = ips.utils.url.getParam( 'filter' ) == 'getByUser' ? true : false;
			var getOnlineUsers = ips.utils.url.getParam( 'filter' ) == 'getOnlineUsers' ? true : false;

			if ( getByUser || getOnlineUsers )
			{
				if ( !!$( '#mapMarkers' ).html() )
				{
					try {
						var markersJSON = $.parseJSON( $( '#mapMarkers' ).html() );
						if ( markersJSON.length > 0 )
						{
							setMarkers( markersJSON );
						}
						else
						{
							ips.ui.flashMsg.show( ips.getString( 'membermap_no_results' ), { timeout: 3, position: 'bottom' } );
						}
					}
					catch(err) {}
				}
			}

			/* Set lat/lon from URL */
			var centerLat = parseFloat( unescape( ips.utils.url.getParam( 'lat' ) ).replace( ',', '.' ) );
			var centerLng = parseFloat( unescape( ips.utils.url.getParam( 'lng' ) ).replace( ',', '.' ) );
			if ( centerLat && centerLng )
			{
				setCenter( centerLat, centerLng );
			}

			/* Set zoom level from URL */
			var initZoom = parseInt( ips.utils.url.getParam( 'zoom' ) );
			
			if ( initZoom )
			{
				setZoomLevel( initZoom );
			}

			/* Set default map from URL */
			var defaultMap = ips.utils.url.getParam( 'map' );
			if ( defaultMap )
			{
				setDefaultMap( defaultMap );
			}

			/* Are we embedding? */
			setEmbed( ips.utils.url.getParam( 'do' ) == 'embed' ? 1 : 0 );

			
			/* Set a height of the map that fits our browser height */
			setMapHeight();
			
			setupMap();
			

			/* Load all markers */
			loadMarkers();
		
			
			/* Init events */
			initEvents();	
		},
		
		setMobileDevice = function( bool )
		{
			isMobileDevice = bool;
		},
		
		setDefaultMap = function( map )
		{
			defaultMapTypeId = map;
		},
		
		setEmbed = function( bool )
		{
			isEmbedded = bool;
		},
		
		clear =function()
		{
			mapMarkers.clearLayers();
			oms.clearMarkers();
		},
		
		reloadMap = function()
		{
			Debug.log( "Reloading map" );
			clear();
			showMarkers( true );
		},

		setupMap = function()
		{
			var southWest = new L.LatLng( 56.83, -7.14 );
			var northEast = new L.LatLng( 74.449, 37.466 );
			bounds = new L.LatLngBounds(southWest, northEast);

			mapServices.esriworldstreetmap = L.tileLayer.provider( 'Esri.WorldStreetMap' );
			mapServices.thunderforestlandscape = L.tileLayer.provider( 'Thunderforest.Landscape' );
			mapServices.mapquest = L.tileLayer.provider('MapQuestOpen.OSM');			
			mapServices.esriworldtopomap = L.tileLayer.provider( 'Esri.WorldTopoMap' );

			var contextMenu = [];

			contextMenu.push(
			{
				text: ips.getString( 'membermap_centerMap' ),
				callback: function(e) 
				{
					map.flyTo(e.latlng);
				}
			}, 
			'-', 
			{
				text: ips.getString( 'membermap_zoomIn' ),
				icon: icons.zoomIn,
				callback: function() 
				{
					map.zoomIn();
				}
			}, 
			{
				text: ips.getString( 'membermap_zoomOut' ),
				icon: icons.zoomOut,
				callback: function() 
				{
					map.zoomOut();
				}
			});
			

			var defaultMap = 'mapquest';
			var newDefault = '';
			
			if ( typeof ips.utils.cookie.get( 'membermap_baseMap' ) == 'string' && ips.utils.cookie.get( 'membermap_baseMap' ).length > 0 )
			{
				newDefault = ips.utils.cookie.get( 'membermap_baseMap' ).toLowerCase();
			}
			
			if ( defaultMapTypeId !== null )
			{
				newDefault = defaultMapTypeId;
			}
			
			if ( newDefault !== '' )
			{
				if ( mapServices[ newDefault ] !== undefined )
				{
					defaultMap = newDefault;
				}
			}

			map = L.map( 'mapCanvas', 
			{
				zoom: ( zoomLevel || 7 ),
				layers: [ mapServices[ defaultMap ] ],
				contextmenu: ( isMobileDevice ? false : true ),
				contextmenuWidth: 180,
				contextmenuItems: contextMenu,
				fullscreenControl: isMobileDevice ? false : true,
				loadingControl: isMobileDevice ? false : true,
				attributionControl: true,
				crs: L.CRS.EPSG3857
			});
			
			
			if ( isMobileDevice === false ) 
			{
				L.control.scale().addTo(map);
			}

			map.fitBounds( bounds );
			
			oms = new OverlappingMarkerSpiderfier( map, { keepSpiderfied: true } );
			
			var popup = new L.Popup({
				offset: new L.Point(0, -20),
				keepInView: true,
				maxWidth: ( isMobileDevice ? 250 : 300 )
			});
			
			oms.addListener( 'click', function( marker ) 
			{
				popup.setContent( marker.markerData.popup );
				popup.setLatLng( marker.getLatLng() );
				map.openPopup( popup );
			});
			
			oms.addListener('spiderfy', function( omsMarkers ) 
			{
				omsMarkers.each( function( omsMarker )
				{
					omsMarker.setIcon( omsMarker.options.spiderifiedIcon );
				});
				map.closePopup();
			});
			
			oms.addListener('unspiderfy', function(omsMarkers) 
			{
				omsMarkers.each( function( omsMarker )
				{
					omsMarker.setIcon( omsMarker.options.defaultIcon );
				});
			});

			mapMarkers = new L.MarkerClusterGroup({ spiderfyOnMaxZoom: false, zoomToBoundsOnClick: false, disableClusteringAtZoom: ( $( '#mapWrapper' ).height() > 1000 ? 12 : 9 ) });
			
			mapMarkers.on( 'clusterclick', function (a) 
			{
				map.fitBounds( a.layer._bounds );
				if ( map.getZoom() > ( $( '#mapWrapper' ).height() > 1000 ? 12 : 9 ) )
				{
					map.setZoom( $( '#mapWrapper' ).height() > 1000 ? 12 : 9 );
				}
			});

			map.addLayer( mapMarkers );
			
			baseMaps = {
				"MapQuest": mapServices.mapquest,
				"Thunderforest Landscape": mapServices.thunderforestlandscape,
				'Esri WorldTopoMap': mapServices.esriworldtopomap,
				'Esri World Street Map': mapServices.esriworldstreetmap
			};

			overlayMaps = {
				"Members": mapMarkers,
			};

			L.control.layers( baseMaps, overlayMaps, { collapsed: ( isMobileDevice || isEmbedded ? true : false ) } ).addTo( map );

			map.on( 'baselayerchange', function( baselayer )
			{
				ips.utils.cookie.set( 'membermap_baseMap', baselayer.name.toLowerCase().replace( /\s/g, '' ) );
			});
			
			ips.membermap.map = map;
		},
		
		setMarkers = function( markers )
		{
			allMarkers = markers.markers;
		},

		reloadMarkers = function()
		{
			if ( oldMarkersIndicator !== null )
			{
				ips.membermap.map.removeControl( oldMarkersIndicator );
			}
			
			clear();

			loadMarkers( true );
		},
		
		loadMarkers = function( forceReload )
		{
			forceReload = typeof forceReload !== 'undefined' ? forceReload : false;

			if ( ips.utils.url.getParam( 'rebuildCache' ) == 1 || ips.utils.url.getParam( 'dropBrowserCache' ) == 1 )
			{
				forceReload = true;
			}

			/* Skip this if markers was loaded from DOM */
			if ( allMarkers && allMarkers.length > 0 )
			{
				showMarkers();
				return;
			}

			if ( ! ips.utils.db.isEnabled() )
			{
				$( '#elToolsMenuBrowserCache' ).addClass( 'ipsMenu_itemDisabled' );
				$( '#elToolsMenuBrowserCache a' ).append( '(Not supported)' );
			}

			if ( forceReload || ! ips.utils.db.isEnabled() )
			{
				allMarkers = [];

				$.ajax( ipsSettings.baseURL.replace('&amp;','&') + 'datastore/membermap_cache/membermap-index.json',
				{	
					cache : false,
					dataType: 'json',
					success: function( res )
					{
						if ( typeof res.error !== 'undefined' )
						{
							alert(res.error);
						}

						if ( res.fileList.length === 0 )
						{
							return false;
						}

						var promise;

						$.each( res.fileList, function( id, file )
						{
							promise = $.when( promise, 
								$.ajax({
									url: ipsSettings.baseURL.replace('&amp;','&') + '/datastore/' + file,
									cache : false,
									dataType: 'json',
									success:function( res )
									{
										/* Show marker layer */
										showMarkers( false, res );
										allMarkers = allMarkers.concat( res );
									}
								})
							);
						});

						/* Store data in browser when all AJAX calls complete */
						promise.done(function()
						{
							if ( ips.utils.db.isEnabled() )
							{
								var date = new Date();
								ips.utils.db.set( 'membermap', 'markers', { time: ( date.getTime() / 1000 ), data: allMarkers } );
								ips.utils.db.set( 'membermap', 'cacheTime', ips.getSetting( 'membermap_cacheTime' ) );


								$( '#elToolsMenuBrowserCache a time' ).html( '(Last update: ' + ips.utils.time.readable( date.getTime() / 1000 ) + ')' );
							}
						});
					}
				});
			}
			else
			{
				/* Get data from browser storage */
				var data 		= ips.utils.db.get('membermap', 'markers' );
				var cacheTime 	= ips.utils.db.get('membermap', 'cacheTime' );
			
				if ( data === null || cacheTime < ips.getSetting( 'membermap_cacheTime' ) )
				{
					reloadMarkers();
					return;
				}

				if ( data.data.length > 0 && typeof data.data !== 'null' )
				{
					/* Reload cache if it's older than 24 hrs */
					var date = new Date( data.time * 1000 ),
					nowdate = new Date;
					if ( ( ( nowdate.getTime() - date.getTime() ) / 1000 ) > 86400 )
					{
						reloadMarkers();
						return;
					}

					allMarkers = data.data;
					showMarkers( false, data.data );
					
					/* Inform that we're showing markers from browser cache */
					if ( oldMarkersIndicator === null && ! isEmbedded )
					{
						oldMarkersIndicator = new L.Control.MembermapOldMarkers({ callback: reloadMarkers, time: date });
						ips.membermap.map.addControl( oldMarkersIndicator );
					}

					$( '#elToolsMenuBrowserCache a time' ).html( '(Last update: ' + ips.utils.time.readable( date / 1000 ) + ')' );
				}
				else
				{
					reloadMarkers();
					return;
				}
			}

		},
		
		initEvents = function()
		{
			/* And adjust it if we resize our browser */
			if ( isMobileDevice === false && isEmbedded === false )
			{
				$( "#mapWrapper" ).resizable(
				{
					zIndex: 15000,
					handles: 's',
					stop: function(event, ui) 
					{
						$(this).css("width", '');
					},
					resize: function( event, ui )
					{
						map.invalidateSize();
					}
				});
			}
			

			
			/* Get by member */
			$( '#elInput_membermap_memberName' ).on( 'tokenAdded tokenDeleted', function()
			{
				reloadMap();
			});

			$( '#membermap_button_addLocation' ).click( function()
			{
				if ( typeof popups['addLocationPopup'] === 'object' )
				{
					popups['addLocationPopup'].destruct();
					popups['addLocationPopup'].remove();
					delete popups['addLocationPopup'];
				}

				popups['addLocationPopup'] = ips.ui.dialog.create({
					title: ips.getString( 'membermap_location_title' ),
					url: ips.getSetting('baseURL') + 'index.php?app=membermap&module=membermap&controller=showmap&do=add',
					callback: function()
					{
						if( ! navigator.geolocation )
						{
							$( '#membermap_geolocation_wrapper' ).hide();
						}
						else
						{
							$( '#membermap_currentLocation' ).click( processGeolocation );
						}

						$( '#elInput_membermap_location' ).autocomplete({
							source: function( request, response ) 
							{
								ips.getAjax()({ 
									//url: 'http://www.mapquestapi.com/geocoding/v1/address', 
									url: 'http://open.mapquestapi.com/nominatim/v1/search.php',
									type: 'get',
									dataType: 'json',
									data: {
										key: "pEPBzF67CQ8ExmSbV9K6th4rAiEc3wud",

										// MapQuest Geocode
										/*location: request.term,
										outFormat: 'json'*/

										// MapQuest Nominatim
										format: 'json',
										q: request.term,
										extratags: 0,

									},
									success: function( data ) 
									{
										// MapQuest
										/* If adminArea5 is empty, it's likely we don't have a result */
										/*if ( data.results[0].locations[0].adminArea5 )
										{
											response( $.map( data.results[0].locations, function( item )
											{
												return {
													value: item.adminArea5 + 
														( item.adminArea4 ? ', ' + item.adminArea4 : '' ) + 
														( item.adminArea3 ? ', ' + item.adminArea3 : '' ) + 
														( item.adminArea2 ? ', ' + item.adminArea2 : '' ) +
														( item.adminArea1 ? ', ' + item.adminArea1 : '' ),
													latLng: item.latLng
												};
											}));
										}
										else
										{
											response([]);
										}*/

										// MapQuest Nominatim
										response( $.map( data, function( item )
										{
											return {
												value: item.display_name,
												latLng: {
													lat: item.lat,
													lng: item.lon
												}
											};
										}));

									}
								})
							},
							minLength: 3,
							select: function( event, ui ) {
								$( '#membermap_form_location input[name="lat"]' ).val( parseFloat( ui.item.latLng.lat).toFixed(6) );
								$( '#membermap_form_location input[name="lng"]' ).val( parseFloat( ui.item.latLng.lng).toFixed(6) );
							}
						});

						$( '#membermap_form_location' ).on( 'submit', function(e)
						{
							if ( $( '#membermap_form_location input[name="lat"]' ).val().length == 0 || $( '#membermap_form_location input[name="lng"]' ).val().length == 0 )
							{
								e.preventDefault();
								return false;
							}
						});
					}
				});

				popups['addLocationPopup'].show();
			})
		},



		processGeolocation = function(e)
		{
			e.preventDefault();
			if(navigator.geolocation)
			{
				navigator.geolocation.getCurrentPosition( function( position )
				{
					$( '#membermap_form_location input[name="lat"]' ).val( position.coords.latitude );
					$( '#membermap_form_location input[name="lng"]' ).val( position.coords.longitude );

					$( '#membermap_form_location' ).submit();
					return;

					/* Skip this for now, will have to see how many requests this app consumes per month */

					ips.getAjax()({ 
						url: 'http://www.mapquestapi.com/geocoding/v1/reverse', 
						type: 'get',
						dataType: 'json',
						data: {
							key: "pEPBzF67CQ8ExmSbV9K6th4rAiEc3wud",
							lat: position.coords.latitude,
							lng: position.coords.longitude

						},
						success: function( data ) 
						{
							// MapQuest
							/* If adminArea5 is empty, it's likely we don't have a result */
							if ( data.results[0].locations[0].adminArea5 )
							{
								var item = data.results[0].locations[0];
								var location = item.adminArea5 + 
											( item.adminArea4 ? ', ' + item.adminArea4 : '' ) + 
											( item.adminArea3 ? ', ' + item.adminArea3 : '' ) + 
											( item.adminArea2 ? ', ' + item.adminArea2 : '' ) +
											( item.adminArea1 ? ', ' + item.adminArea1 : '' );

								$( '#elInput_membermap_location' ).val( location );

								$( '#membermap_form_location' ).submit();
									
							}
							else
							{
								$( '#membermap_geolocation_wrapper' ).hide();
								$( '#membermap_addLocation_error' ).html( ips.getString( 'memebermap_geolocation_error' ) ).show();
							}

						}
					});

				},
				function( error )
				{
					$( '#membermap_addLocation_error' ).append( 'ERROR(' + error.code + '): ' + error.message ).append( '<br />' + ips.getString( 'memebermap_geolocation_error' ) ).show();
					$( '#membermap_geolocation_wrapper' ).hide();
				},
				{
					maximumAge: (1000 * 60 * 15),
					enableHighAccuracy: true
				});
			}
		},

		setZoomLevel = function( setZoomLevel )
		{
			zoomLevel = parseInt( setZoomLevel, 10 );
		},

		setCenter = function( setLat, setLng )
		{
			initialCenter = new L.LatLng( parseFloat( setLat ), parseFloat( setLng ) );
		},
		
		setMapHeight = function()
		{
			if ( stuffSize === 0 )
			{
				stuffSize = $( '#membermapWrapper' ).offset().top;
			}
			
			var browserHeight = $( window ).height();
			
			var scrollY = ( window.pageYOffset !== undefined ) ? window.pageYOffset : (document.documentElement || document.body.parentNode || document.body).scrollTop; /* DIE IE */
			var leftForMe;
			
			if ( scrollY > stuffSize )
			{
				leftForMe = $( window ).height();
			}
			else
			{
				leftForMe = browserHeight - stuffSize + scrollY;
			}
			if ( $( '#mapWrapper' ).height() !== leftForMe )
			{
				$( '#mapWrapper' ).css( { height: leftForMe } );
				
				return true;
			}
			
			return false;
		},
	
		showMarkers = function( dontRepan, markers )
		{
			dontRepan = typeof dontRepan !== 'undefined' ? dontRepan : false;
			markers = typeof markers !== 'undefined' ? markers : false;

			var getByUser 	= ips.utils.url.getParam( 'filter' ) == 'getByUser' ? true : false;
			var memberId 	= parseInt( ips.utils.url.getParam( 'member_id' ) );
			var flyToZoom 	= 8;
			var hasLocation = false;

			if ( markers === false )
			{
				markers = allMarkers;
			}

			if ( markers.length > 0 )
			{

				var memberSearch = $( '#elInput_membermap_memberName_wrapper .cToken' ).eq(0).attr( 'data-value' );


				$.each( markers, function() 
				{		
					/* Don't show these, as they all end up in the middle of the middle of the South Atlantic Ocean. */
					if ( this.lat == 0 && this.lon == 0 )
					{
						return;
					}

					/* Report written by selected member? */
					if ( typeof memberSearch !== 'undefined' )
					{
						/* Names of 'null' are deleted members */
						if (this.name == null || memberSearch.toLowerCase() !== this.name.toLowerCase() )
						{
							return;
						}
					}
					
					var bgColour 	= 'darkblue';
					var icon 		= 'user';
					var iconColour 	= 'white';

					if ( this.type == 'member' )
					{
						if ( this.member_id == ips.getSetting( 'member_id' ) )
						{
							/* This is me! */
							icon = 'home';
							bgColour = 'green';

							$( '#membermap_addLocation_wrapper' ).hide();
							$( '#membermap_myLocation_wrapper' ).show();

							/* Update the button label while we're here */
							if ( ! ips.getSetting( 'membermap_canEdit' ) )
							{
								$( 'li#membermap_button_addLocation' ).addClass( 'ipsMenu_itemDisabled' );
								$( 'li#membermap_button_addLocation' ).attr( 'data-ipsTooltip', '' ).attr( 'title', ips.getString( 'membermap_cannot_edit_location' ) );
							}

							hasLocation = true;

							if ( ips.utils.url.getParam( 'goHome' ) == 1 )
							{
								getByUser 	= true;
								memberId 	= this.member_id;
								flyToZoom 	= 10;
							}
							
						}
						else
						{
							if ( this.markerColour )
							{
								bgColour = this.markerColour;
							}
						}
					}
					else
					{
						iconColour 	= this.colour;
						icon 		= this.icon || 'fa-map-marker';
						bgColour 	= this.bgColour;

					}

					var icon = L.AwesomeMarkers.icon({
						prefix: 'fa',
						icon: icon, 
						markerColor: bgColour,
						iconColor: iconColour
					});

					var spiderifiedIcon = L.AwesomeMarkers.icon({
						prefix: 'fa',
						icon: 'users', 
						markerColor: bgColour,
						iconColor: iconColour
					});
					

					var contextMenu = [];
					var enableContextMenu = false;

					if ( ips.getSetting( 'is_supmod' ) ||  ( ips.getSetting( 'member_id' ) == this.member_id && ips.getSetting( 'membermap_canDelete' ) ) )
					{
						enableContextMenu = true;
						contextMenu = getMarkerContextMenu( this );
					}
					
					var mapMarker = new L.Marker( 
						[ this.lat, this.lon ], 
						{ 
							title: this.title,
							icon: icon,
							spiderifiedIcon: spiderifiedIcon,
							defaultIcon: icon,
							contextmenu: enableContextMenu,
						    contextmenuItems: contextMenu
						}
					);
					
					mapMarker.markerData = this;

					oms.addMarker( mapMarker );
					mapMarkers.addLayer( mapMarker );

					if ( getByUser && memberId > 0 && this.type == 'member' && this.member_id == memberId )
					{
						dontRepan = true;
						map.flyTo( mapMarker.getLatLng(), flyToZoom );
					}
				});
			}


			/* Contextual menu */
			/* Needs to run this after the markers, as we need to know if we're editing or adding the location */
			if ( ips.getSetting( 'member_id' ) )
			{
				if ( hasLocation && ips.getSetting( 'membermap_canEdit' ) )
				{
					map.contextmenu.insertItem(
					{
						'text': ips.getString( 'membermap_context_editLocation' ),
						callback: updateLocation
					}, 0 );
					map.contextmenu.insertItem( { separator: true }, 1 );
				}
				else if ( ! hasLocation && ips.getSetting( 'membermap_canAdd' ) )
				{
					map.contextmenu.insertItem(
					{
						'text': ips.getString( 'membermap_context_addLocation' ),
						callback: updateLocation
					}, 0 );
					map.contextmenu.insertItem( { separator: true }, 1 );
				}
			}


			/* We don't want to move the map around if we're changing filters or reloading markers */
			if ( dontRepan === false )
			{
				if ( initialCenter instanceof L.LatLng )
				{
					if ( zoomLevel )
					{
						map.flyTo( initialCenter, zoomLevel, { duration: 1.4 } );
					}
					else
					{
						map.flyTo( initialCenter );
					}
				}
				else
				{
					map.fitBounds( mapMarkers.getBounds(), { 
						padding: [50, 50],
						maxZoom: 11
					});
				}
			}
		},

		updateLocation = function( e )
		{
			Debug.log( e );
			ips.ui.alert.show({
				type: 'confirm',
				message: ips.getString( 'membermap_confirm_updateLocation' ),
				callbacks:
				{
					'ok': function() 
					{ 
						var url = ips.getSetting('baseURL') + "index.php?app=membermap&module=membermap&controller=showmap&do=add&csrfKey=" + ips.getSetting( 'csrfKey' );
						ips.getAjax()({ 
							url: url,
							data: {
								lat: e.latlng.lat,
								lng: e.latlng.lng,
								'membermap_form_location_submitted': 1
							},
							type: 'POST'
						}).done( function( data )
						{
							if ( data['error'] )
							{
								ips.ui.alert.show({ type: 'alert', message: data['error'] });
							}
							else
							{
								window.location.replace( ips.getSetting('baseURL') + "index.php?app=membermap&dropBrowserCache=1&goHome=1" );
							}
						}); 
					}
				}
			});
		},


		getMarkerContextMenu = function( marker, markerData )
		{
			
			if ( ips.getSetting( 'is_supmod' ) ||  ( ips.getSetting( 'member_id' ) == marker.member_id && ips.getSetting( 'membermap_canDelete' ) ) ) 
			{
				return [{
					'text': 'Delete',
					index: 0,
					callback: function(e)
					{
						ips.ui.alert.show({
							type: 'confirm',
							callbacks:
							{
								'ok': function() 
								{ 
									var url = ips.getSetting('baseURL') + "index.php?app=membermap&module=membermap&controller=showmap&do=delete&member_id="+ marker.member_id;
									ips.getAjax()({ 
										url: url, 
										type: 'GET'
									}).done( function( data )
									{
										if ( data['error'] )
										{
											ips.ui.alert.show({ type: 'alert', message: data['error'] });
										}
										else
										{
											window.location.replace( ips.getSetting('baseURL') + "index.php?app=membermap&dropBrowserCache=1" );
										}
									}); 
								}
							}
						});
					}
				},
				{
					separator: true,
					index: 1
				}];
			}

			return [];
		},
		
		markerClickFunction = function( marker )
		{
			var hidingMarker = currentPlace;
			
	
			var zoomIn = function( info ) 
			{
				previousZoomLevel = map.getZoom();
				
				//map.setCenter( marker.getLatLng() );
				map.flyTo( marker.getLatLng() );
				if ( map.getZoom() <= 11 )
				{
					map.setZoom( 11 );
				}
				
			};
			
			if ( currentPlace ) 
			{
				if ( hidingMarker !== marker ) 
				{
					zoomIn( marker.markerData );
				}
				else
				{
					currentPlace = null;
					map.setZoom( previousZoomLevel );
				}
			} 
			else 
			{
				zoomIn( marker.markerData );
			}
			
			currentPlace = marker;
		};

		return {
			initMap: initMap,
			setDefaultMap: setDefaultMap,
			setMarkers: setMarkers,
			setCenter: setCenter,
			setZoomLevel: setZoomLevel,
			map: map,
			loadMarkers: loadMarkers
		};
	});
}(jQuery, _));


L.Control.MembermapOldMarkers = L.Control.extend({
    options: {
        position: 'topleft',
        time: null,
        callback: null
    },
    initialize: function( options )
    {
    	L.setOptions(this, options);
    }, 
    onAdd: function (map) {
        // create the control container with a particular class name
        var container = L.DomUtil.create('div', 'leaflet-control-layers leaflet-control-layers-expanded leaflet-control-cached-warning');
		//container.setOpacity( 1 );
        /* Date */
		var info = L.DomUtil.create('p', '', container);
		info.innerHTML = ips.getString( 'membermap_cached_markers', {date: ips.utils.time.localeDateString( this.options.time, { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' } )} );
		
        var link = L.DomUtil.create('a', 'test', container);
		link.innerHTML = ips.getString( 'membermap_cached_markers_refresh' );
		link.href = '#';
		
		L.DomEvent
		    .on(link, 'click', L.DomEvent.preventDefault)
		    .on(link, 'click', this.options.callback );
        // ... initialize other DOM elements, add listeners, etc.

        return container;
    }
});]]></file>
 <file javascript_app="membermap" javascript_location="admin" javascript_path="controllers/membermap" javascript_name="ips.membermap.groupform.js" javascript_type="controller" javascript_version="100003" javascript_position="1000050">;( function($, _, undefined){&#13;
	&quot;use strict&quot;;&#13;
&#13;
	ips.controller.register('membermap.admin.membermap.groupform', {&#13;
&#13;
		initialize: function () {&#13;
			this.monitorColourPickers();&#13;
		},&#13;
&#13;
		monitorColourPickers: function()&#13;
		{&#13;
			var self		= this;&#13;
			var icon 		= $( 'input[name=&quot;group_pin_icon&quot;]' ).eq(0);&#13;
			var iconColour 	= $( 'input[name=&quot;group_pin_colour&quot;]' ).eq(0);&#13;
			var bgColour 	= $( 'input[name=&quot;group_pin_bg_colour&quot;]' );&#13;
&#13;
&#13;
			bgColour.on('change', function()&#13;
			{&#13;
				var colour = $( 'input[name=&quot;group_pin_bg_colour&quot;]:checked' ).val();&#13;
				$( '#markerExample' ).removeClass().addClass( 'awesome-marker awesome-marker-icon-' + colour )&#13;
			});&#13;
&#13;
			iconColour.on('change', function()&#13;
			{&#13;
				$('#markerExample i').css({ 'color': '#' + iconColour.val() });&#13;
			});&#13;
&#13;
			icon.on('change', function()&#13;
			{&#13;
				$('#markerExample i').removeClass().addClass( 'fa fa-fw' ).addClass( icon.val() );&#13;
			});&#13;
&#13;
		}&#13;
	});&#13;
}(jQuery, _));</file>
 <file javascript_app="membermap" javascript_location="admin" javascript_path="controllers/membermap" javascript_name="ips.membermap.markerform.js" javascript_type="controller" javascript_version="100003" javascript_position="1000050"><![CDATA[;( function($, _, undefined){
	"use strict";

	ips.controller.register('membermap.admin.membermap.markerform', {
		map: null,
		popup: null,
		marker: null,
		infowindow: null,
		bounds: null,

		initialize: function () 
		{
			this.setup();
		},

		setup: function()
		{
			$( '#elInput_marker_location' ).autocomplete({
				source: function( request, response ) 
				{
					ips.getAjax()({ 
						//url: 'http://www.mapquestapi.com/geocoding/v1/address', 
						url: 'http://open.mapquestapi.com/nominatim/v1/search.php',
						type: 'get',
						dataType: 'json',
						data: {
							key: "pEPBzF67CQ8ExmSbV9K6th4rAiEc3wud",

							// MapQuest Geocode
							/*location: request.term,
							outFormat: 'json'*/

							// MapQuest Nominatim
							format: 'json',
							q: request.term,
							extratags: 0,

						},
						success: function( data ) 
						{
							// MapQuest
							/* If adminArea5 is empty, it's likely we don't have a result */
							/*if ( data.results[0].locations[0].adminArea5 )
							{
								response( $.map( data.results[0].locations, function( item )
								{
									return {
										value: item.adminArea5 + 
											( item.adminArea4 ? ', ' + item.adminArea4 : '' ) + 
											( item.adminArea3 ? ', ' + item.adminArea3 : '' ) + 
											( item.adminArea2 ? ', ' + item.adminArea2 : '' ) +
											( item.adminArea1 ? ', ' + item.adminArea1 : '' ),
										latLng: item.latLng
									};
								}));
							}
							else
							{
								response([]);
							}*/

							// MapQuest Nominatim
							response( $.map( data, function( item )
							{
								return {
									value: item.display_name,
									latLng: {
										lat: item.lat,
										lng: item.lon
									}
								};
							}));

						}
					});
				},
				minLength: 3,
				select: function( event, ui ) 
				{
					$( '#membermap_add_marker input[name="marker_lat"]').val( parseFloat( ui.item.latLng.lat ).toFixed(6) );
					$( '#membermap_add_marker input[name="marker_lon"]' ).val( parseFloat( ui.item.latLng.lng ).toFixed(6) );
				}
			});

			var that = this;

			/* Setup map popup */
			$( '#marker_addViaMap' ).click( function()
			{
				ips.loader.get( [ 'membermap/interface/leaflet/leaflet-src.js', 'membermap/interface/leaflet/plugins/leaflet-providers.js', 'membermap/interface/leaflet/plugins/leaflet.awesome-markers.js' ] ).then( function () 
				{
					if(  _.isObject( that.popup ) )
					{
						that.popup.remove( false );
					}

					that.popup = ips.ui.dialog.create({
						content: 	"<div><div id='mapWrapper' class='ipsPad'><div id='mapCanvas' style='height:400px;'></div></div><div id='geocodingError' style='display:none' class='message error'></div>"
								+ "<div class='ipsAreaBackground ipsPad ipsType_right'><span class='ipsButton ipsButton_primary' data-action='dialogClose'>Select</span></div>"
								+ "</div>",
						size: 'wide',
						title: ips.getString( 'marker_addViaMap' )
					});
					that.popup.show();

					that.setupMap();
							
					var icon = L.AwesomeMarkers.icon({
						prefix: 'fa',
						icon: 'map-marker', 
						color: 'darkblue'
					});

					that.infowindow = new L.Popup();
					that.marker = new L.Marker(
						that.bounds.getCenter(),
						{
							draggable: true,
							opacity: 0.0,
							icon: icon
						} 
					).bindPopup( that.infowindow ).addTo( that.map );
					
					/* Show initial marker */
					if ( $( '#membermap_add_marker input[name="marker_lat"]' ).val() != 0 )
					{
						Debug.log( 'Setting initial marker' );
						Debug.log( 'Lat: ' + $( '#membermap_add_marker input[name="marker_lat"]' ).val() );
						Debug.log( 'Lng: ' + $( '#membermap_add_marker input[name="marker_lon"]' ).val() );
						
						that.marker.setLatLng( new L.LatLng( parseFloat( $( '#membermap_add_marker input[name="marker_lat"]' ).val() ), parseFloat( $( '#membermap_add_marker input[name="marker_lon"]' ).val() ) ) );
						that.marker.setOpacity( 1 );

						that.infowindow.setContent( $( '#elInput_marker_name' ).val() + '<br />' + $( '#elInput_marker_location' ).val() );

						that.marker.openPopup();
					
						that.map.flyTo( that.marker.getLatLng(), 8 );

					}
					else
					{
						that.map.panTo( that.bounds.getCenter() );
						that.map.setZoom( that.map.getZoom() + 1 );
					}
					
					that.marker.on( 'dragend', function( e ) 
					{
						var coords = e.target.getLatLng();
						that.findMarkerPosition( coords.lat, coords.lng );
					});
					
					that.map.on( 'click', function( e )
					{
						that.findMarkerPosition( e.latlng.lat, e.latlng.lng );
					});
				});
				
			});
		},

		setupMap: function()
		{
			if (_.isObject( this.map ) )
			{
				this.map.remove();
			}

			var southWest = new L.LatLng( 56.83, -7.14 );
			var northEast = new L.LatLng( 74.449, 37.466 );
			this.bounds = new L.LatLngBounds(southWest, northEast);

			var mapServices = {};
			mapServices.esriworldstreetmap = L.tileLayer.provider( 'Esri.WorldStreetMap' );
			mapServices.thunderforestlandscape = L.tileLayer.provider( 'Thunderforest.Landscape' );
			mapServices.mapquest = L.tileLayer.provider('MapQuestOpen.OSM');			
			mapServices.esriworldtopomap = L.tileLayer.provider( 'Esri.WorldTopoMap' );

			this.map = L.map( 'mapCanvas', 
			{
				zoom: 7,
				layers: [ mapServices.mapquest ],
				attributionControl: true,
				crs: L.CRS.EPSG3857
			});

			this.map.fitBounds( this.bounds );


			
			var baseMaps = {
				"MapQuest": mapServices.mapquest,
				"Thunderforest Landscape": mapServices.thunderforestlandscape,
				'Esri WorldTopoMap': mapServices.esriworldtopomap,
				'Esri World Street Map': mapServices.esriworldstreetmap
			};

			L.control.layers( baseMaps ).addTo( this.map );

		},

		findMarkerPosition: function( lat, lng )
		{
			var that = this;

			ips.getAjax()({ 
				url: 'http://www.mapquestapi.com/geocoding/v1/reverse', 
				type: 'get',
				dataType: 'json',
				data: {
					key: "pEPBzF67CQ8ExmSbV9K6th4rAiEc3wud",
					lat: lat,
					lng: lng

				},
				success: function( data ) 
				{
					// MapQuest
					/* If adminArea5 is empty, it's likely we don't have a result */
					if ( data.results[0].locations[0].adminArea4 )
					{
						var item = data.results[0].locations[0];
						var location = ( item.adminArea5 ? item.adminArea5 : '' ) + 
									( item.adminArea4 ? ', ' + item.adminArea4 : '' ) + 
									( item.adminArea3 ? ', ' + item.adminArea3 : '' ) + 
									( item.adminArea2 ? ', ' + item.adminArea2 : '' ) +
									( item.adminArea1 ? ', ' + item.adminArea1 : '' );

						that.marker.setLatLng( [ lat, lng ] );
						that.marker.setOpacity( 1 );
						that.infowindow.setContent( location );

						that.marker.openPopup();
						
						$( '#elInput_marker_location' ).val( location );
						$( '#membermap_add_marker input[name="marker_lat"]' ).val( lat );
						$( '#membermap_add_marker input[name="marker_lon"]' ).val( lng );
						$( '#geocodingError' ).hide();
					}
					else
					{
						$( '#geocodingError' ).text( 'No results found' ).show();
					}

				}
			});
		}
	});
}(jQuery, _));]]></file>
</javascript>
